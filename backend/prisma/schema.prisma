generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Announcement {
  id           String      @id @default(cuid())
  createdById  String
  scope        String
  departmentId String?
  levelId      String?
  title        String
  message      String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  User         User        @relation(fields: [createdById], references: [id], onDelete: Cascade)
  Department   Department? @relation(fields: [departmentId], references: [id])
  Level        Level?      @relation(fields: [levelId], references: [id])

  @@index([createdAt])
  @@index([scope])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String
  action    String
  entity    String
  entityId  String?
  metadata  String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  User      User     @relation(fields: [actorId], references: [id])

  @@index([actorId])
  @@index([createdAt])
  @@index([entity])
}

model Course {
  id                        String                      @id @default(cuid())
  code                      String                      @unique
  title                     String
  credits                   Int
  description               String?
  departmentId              String
  levelId                   String
  expectedSize              Int                         @default(50)
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  Department                Department                  @relation(fields: [departmentId], references: [id])
  Level                     Level                       @relation(fields: [levelId], references: [id])
  CourseAllocation          CourseAllocation[]
  ExamSession               ExamSession[]
  StudentCourseRegistration StudentCourseRegistration[]
  TimetableSession          TimetableSession[]

  @@index([code])
  @@index([departmentId])
  @@index([levelId])
}

model CourseAllocation {
  id         String   @id @default(cuid())
  courseId   String
  lecturerId String
  semesterId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [lecturerId], references: [id], onDelete: Cascade)
  Semester   Semester @relation(fields: [semesterId], references: [id], onDelete: Cascade)

  @@unique([courseId, semesterId])
  @@index([lecturerId])
  @@index([semesterId])
}

model Department {
  id           String         @id @default(cuid())
  code         String         @unique
  name         String
  description  String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  Announcement Announcement[]
  Course       Course[]
  User         User[]
  StudentGroup StudentGroup[]
}

model ExamSession {
  id         String   @id @default(cuid())
  courseId   String
  venueId    String
  semesterId String
  date       DateTime
  startTime  String
  endTime    String
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Semester   Semester @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  Venue      Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([semesterId])
  @@index([venueId])
}

model LecturerAvailability {
  id         String   @id @default(cuid())
  lecturerId String
  dayOfWeek  Int
  startTime  String
  endTime    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  User       User     @relation(fields: [lecturerId], references: [id], onDelete: Cascade)

  @@unique([lecturerId, dayOfWeek, startTime, endTime])
  @@index([lecturerId])
}

model Level {
  id           String         @id @default(cuid())
  code         String         @unique
  name         String
  description  String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  Announcement Announcement[]
  Course       Course[]
  User         User[]
  StudentGroup StudentGroup[]
}

model Notification {
  id          String           @id @default(cuid())
  recipientId String
  title       String
  message     String
  type        NotificationType
  readAt      DateTime?
  metadata    String?
  createdAt   DateTime         @default(now())
  User        User             @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([readAt])
  @@index([recipientId])
}

model Semester {
  id                        String                      @id @default(cuid())
  year                      Int
  term                      String
  startDate                 DateTime
  endDate                   DateTime
  status                    String                      @default("UPCOMING")
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  CourseAllocation          CourseAllocation[]
  ExamSession               ExamSession[]
  StudentCourseRegistration StudentCourseRegistration[]
  TimetableSession          TimetableSession[]
  AcademicCalendarEvent     AcademicCalendarEvent[]
  StudentGroup              StudentGroup[]

  @@unique([year, term])
  @@index([status])
}

model StudentCourseRegistration {
  id           String    @id @default(cuid())
  studentId    String
  courseId     String
  semesterId   String
  registeredAt DateTime  @default(now())
  droppedAt    DateTime?
  Course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Semester     Semester  @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  User         User      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, semesterId])
  @@index([semesterId])
  @@index([studentId])
}

model SupportTicket {
  id         String         @id @default(cuid())
  userId     String
  category   TicketCategory
  subject    String
  message    String
  screenshot String?
  status     TicketStatus   @default(OPEN)
  adminNotes String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime
  resolvedAt DateTime?
  User       User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model TimetableSession {
  id         String        @id @default(cuid())
  courseId   String
  lecturerId String
  venueId    String
  semesterId String
  dayOfWeek  Int
  startTime  String
  endTime    String
  status     SessionStatus @default(DRAFT)
  notes      String?
  version    Int           @default(1)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime
  Course     Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User       User          @relation(fields: [lecturerId], references: [id], onDelete: Cascade)
  Semester   Semester      @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  Venue      Venue         @relation(fields: [venueId], references: [id], onDelete: Cascade)
  Attendance Attendance[]

  @@index([courseId, semesterId, dayOfWeek, startTime])
  @@index([dayOfWeek])
  @@index([lecturerId])
  @@index([semesterId])
  @@index([status])
  @@index([venueId])
}

model TimetableVersion {
  id          String    @id @default(cuid())
  semesterId  String
  version     Int
  publishedAt DateTime?
  publishedBy String?
  notes       String?
  createdAt   DateTime  @default(now())

  @@unique([semesterId, version])
  @@index([semesterId])
}

model User {
  id                        String                      @id @default(cuid())
  pugId                     String                      @unique
  email                     String                      @unique
  passwordHash              String
  firstName                 String
  lastName                  String
  phone                     String?
  profilePhoto              String?
  role                      UserRole                    @default(STUDENT)
  status                    UserStatus                  @default(ACTIVE)
  departmentId              String?
  levelId                   String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  Announcement              Announcement[]
  AuditLog                  AuditLog[]
  CourseAllocation          CourseAllocation[]
  LecturerAvailability      LecturerAvailability[]
  Notification              Notification[]
  StudentCourseRegistration StudentCourseRegistration[]
  SupportTicket             SupportTicket[]
  TimetableSession          TimetableSession[]
  Department                Department?                 @relation(fields: [departmentId], references: [id])
  Level                     Level?                      @relation(fields: [levelId], references: [id])
  AttendanceAsStudent       Attendance[]                @relation("StudentAttendance")
  AttendanceAsMarker        Attendance[]                @relation("AttendanceMarker")
  GroupMembers              GroupMember[]               @relation("GroupMembers")
  ResourceBookings          ResourceBooking[]
  NotificationPreference    NotificationPreference?

  @@index([departmentId])
  @@index([email])
  @@index([levelId])
  @@index([pugId])
  @@index([role])
}

model Venue {
  id               String             @id @default(cuid())
  name             String
  location         String?
  capacity         Int
  type             String
  resources        String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  ExamSession      ExamSession[]
  TimetableSession TimetableSession[]
  ResourceBookings ResourceBooking[]

  @@index([name])
  @@index([type])
}

enum NotificationType {
  TIMETABLE_CHANGE
  CLASS_REMINDER
  ANNOUNCEMENT
  SYSTEM
}

enum SessionStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

enum TicketCategory {
  TECHNICAL
  ACADEMIC
  TIMETABLE
  OTHER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum UserRole {
  STUDENT
  LECTURER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Feature #6: Attendance Tracking
model Attendance {
  id               String           @id @default(cuid())
  sessionId        String
  studentId        String
  status           AttendanceStatus @default(PRESENT)
  markedAt         DateTime         @default(now())
  markedBy         String
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  TimetableSession TimetableSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  Student          User             @relation("StudentAttendance", fields: [studentId], references: [id], onDelete: Cascade)
  Marker           User             @relation("AttendanceMarker", fields: [markedBy], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([markedAt])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// Feature #7: Academic Calendar
model AcademicCalendarEvent {
  id          String            @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  type        CalendarEventType
  isHoliday   Boolean           @default(false)
  semesterId  String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  Semester    Semester?         @relation(fields: [semesterId], references: [id], onDelete: Cascade)

  @@index([startDate])
  @@index([semesterId])
  @@index([type])
}

enum CalendarEventType {
  HOLIDAY
  EXAM_PERIOD
  REGISTRATION
  BREAK
  ORIENTATION
  GRADUATION
  OTHER
}

// Feature #14: Resource Booking
model ResourceBooking {
  id           String        @id @default(cuid())
  venueId      String
  resourceType String
  bookedBy     String
  startTime    DateTime
  endTime      DateTime
  purpose      String?
  status       BookingStatus @default(CONFIRMED)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  Venue        Venue         @relation(fields: [venueId], references: [id], onDelete: Cascade)
  Booker       User          @relation(fields: [bookedBy], references: [id], onDelete: Cascade)

  @@index([venueId])
  @@index([startTime])
  @@index([bookedBy])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

// Feature #15: Student Groups/Cohorts
model StudentGroup {
  id           String        @id @default(cuid())
  name         String
  description  String?
  departmentId String?
  levelId      String?
  semesterId   String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  Department   Department?   @relation(fields: [departmentId], references: [id])
  Level        Level?        @relation(fields: [levelId], references: [id])
  Semester     Semester      @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  Members      GroupMember[]

  @@index([semesterId])
  @@index([departmentId])
}

model GroupMember {
  id        String       @id @default(cuid())
  groupId   String
  studentId String
  joinedAt  DateTime     @default(now())
  Group     StudentGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  Student   User         @relation("GroupMembers", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
}

// Feature #17: Notification Preferences
model NotificationPreference {
  id               String   @id @default(cuid())
  userId           String   @unique
  emailEnabled     Boolean  @default(true)
  smsEnabled       Boolean  @default(false)
  pushEnabled      Boolean  @default(true)
  timetableChanges Boolean  @default(true)
  classReminders   Boolean  @default(true)
  announcements    Boolean  @default(true)
  digestFrequency  String   @default("DAILY") // DAILY, WEEKLY, NEVER
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
